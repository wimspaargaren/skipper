
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://opensource.zalando.com/skipper/reference/plugins/">
      
      <link rel="icon" href="../../favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.10">
    
    
      
        <title>Plugins - Skipper</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1fe995fd.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.f1a3b89f.min.css">
        
          
          
          <meta name="theme-color" content="#ffffff">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="white" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#skipper-plugins" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Skipper" class="md-header__button md-logo" aria-label="Skipper" data-md-component="logo">
      
  <img src="../../favicon.ico" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Skipper
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Plugins
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/zalando/skipper/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Skipper" class="md-nav__button md-logo" aria-label="Skipper" data-md-component="logo">
      
  <img src="../../favicon.ico" alt="logo">

    </a>
    Skipper
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/zalando/skipper/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        Reference
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../filters/" class="md-nav__link">
        Filters
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../predicates/" class="md-nav__link">
        Predicates
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../backends/" class="md-nav__link">
        Backends
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../egress/" class="md-nav__link">
        Egress
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../scripts/" class="md-nav__link">
        Scripts
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Plugins
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Plugins
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#plugin-directories" class="md-nav__link">
    Plugin directories
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-a-plugin" class="md-nav__link">
    Building a plugin
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-a-plugin" class="md-nav__link">
    Use a plugin
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filter-plugins" class="md-nav__link">
    Filter plugins
  </a>
  
    <nav class="md-nav" aria-label="Filter plugins">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-filter-plugin" class="md-nav__link">
    Example filter plugin
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#predicate-plugins" class="md-nav__link">
    Predicate plugins
  </a>
  
    <nav class="md-nav" aria-label="Predicate plugins">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-predicate-plugin" class="md-nav__link">
    Example predicate plugin
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dataclient-plugins" class="md-nav__link">
    DataClient plugins
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multitype-plugins" class="md-nav__link">
    MultiType plugins
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#opentracing-plugins" class="md-nav__link">
    OpenTracing plugins
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../development/" class="md-nav__link">
        Development
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/video-howto-build/" class="md-nav__link">
        Video - How to build
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_10" type="checkbox" id="__nav_2_10" >
      
      <label class="md-nav__link" for="__nav_2_10">
        Data Clients
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Data Clients" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_10">
          <span class="md-nav__icon md-icon"></span>
          Data Clients
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../data-clients/eskip-file/" class="md-nav__link">
        Eskip File
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../data-clients/etcd/" class="md-nav__link">
        Etcd
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../data-clients/kubernetes/" class="md-nav__link">
        Kubernetes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../data-clients/route-string/" class="md-nav__link">
        Route String
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_11" type="checkbox" id="__nav_2_11" >
      
      <label class="md-nav__link" for="__nav_2_11">
        Operation
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Operation" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_11">
          <span class="md-nav__icon md-icon"></span>
          Operation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../operation/deployment/" class="md-nav__link">
        Deployment
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../operation/operation/" class="md-nav__link">
        Operation
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Kubernetes
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Kubernetes" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/ingress-controller/" class="md-nav__link">
        Ingress Controller Deployment
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/ingress-usage/" class="md-nav__link">
        Ingress Usage
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/ingress-backends/" class="md-nav__link">
        Ingress Backends
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/routegroups/" class="md-nav__link">
        RouteGroups
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/routegroup-crd/" class="md-nav__link">
        RouteGroup CRD Semantics
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/routegroup-validation/" class="md-nav__link">
        RouteGroup Validation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/east-west-usage/" class="md-nav__link">
        East-West aka svc-to-svc
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Tutorials
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Tutorials" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/basics/" class="md-nav__link">
        Basics
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/common-use-cases/" class="md-nav__link">
        Common Use Cases
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/auth/" class="md-nav__link">
        Authentication and Autorization
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/ratelimit/" class="md-nav__link">
        Ratelimits
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/shadow-traffic/" class="md-nav__link">
        Shadow Traffic
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/operations/" class="md-nav__link">
        Operations
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/development/" class="md-nav__link">
        Development
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#plugin-directories" class="md-nav__link">
    Plugin directories
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-a-plugin" class="md-nav__link">
    Building a plugin
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-a-plugin" class="md-nav__link">
    Use a plugin
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filter-plugins" class="md-nav__link">
    Filter plugins
  </a>
  
    <nav class="md-nav" aria-label="Filter plugins">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-filter-plugin" class="md-nav__link">
    Example filter plugin
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#predicate-plugins" class="md-nav__link">
    Predicate plugins
  </a>
  
    <nav class="md-nav" aria-label="Predicate plugins">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-predicate-plugin" class="md-nav__link">
    Example predicate plugin
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dataclient-plugins" class="md-nav__link">
    DataClient plugins
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multitype-plugins" class="md-nav__link">
    MultiType plugins
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#opentracing-plugins" class="md-nav__link">
    OpenTracing plugins
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/zalando/skipper/edit/master/docs/reference/plugins.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="skipper-plugins">Skipper plugins<a class="headerlink" href="#skipper-plugins" title="Permanent link">&para;</a></h1>
<p>Skipper may be extended with functionality not present in the core.
These additions can be built as go plugin, so they do not have to
be present in the main skipper repository.</p>
<p>Note the warning from Go&rsquo;s plugin.go:</p>
<div class="codehilite"><pre><span></span><code><span class="err">// The plugin support is currently incomplete, only supports Linux,</span>
<span class="err">// and has known bugs. Please report any issues.</span>
</code></pre></div>


<p>Note the known problem of using plugins together with vendoring, best
described here:</p>
<p><a href="https://github.com/golang/go/issues/20481">https://github.com/golang/go/issues/20481</a></p>
<h2 id="plugin-directories">Plugin directories<a class="headerlink" href="#plugin-directories" title="Permanent link">&para;</a></h2>
<p>Plugins are loaded from sub directories of the plugin directories. By default
the plugin directory is set to <code>./plugins</code> (i.e. relative to skipper&rsquo;s working
directory). An additional directory may be given with the <code>-plugindir=/path/to/dir</code>
option to skipper.</p>
<p>Any file with the suffix <code>.so</code> found below the plugin directories (also in sub
directories) is attempted to load without any arguments. When a plugin needs an
argument, this must be explicitly loaded and the arguments passed, e.g. with
<code>-filter-plugin geoip,db=/path/to/db</code>.</p>
<h2 id="building-a-plugin">Building a plugin<a class="headerlink" href="#building-a-plugin" title="Permanent link">&para;</a></h2>
<p>Each plugin should be built with Go version &gt;= 1.11, enabled Go
modules support similar to the following build command line:</p>
<div class="codehilite"><pre><span></span><code><span class="err">GO111MODULE=on go build -buildmode=plugin -o example.so example.go</span>
</code></pre></div>


<p>There are some pitfalls:</p>
<ul>
<li>packages which are shared between skipper and the plugin <strong>must not</strong> be in
  a <code>vendor/</code> directory, otherwise the plugin will fail to load or in some
  cases give wrong results (e.g. an opentracing span cannot be found in the
  context even if it is present). This also means:
  Do not vendor skipper in a plugin repo&hellip;</li>
<li>plugins must be rebuilt when skipper is rebuilt</li>
<li>do not attempt to rebuild a module and copy it over a loaded plugin, that
  will crash skipper immediately&hellip;</li>
</ul>
<h2 id="use-a-plugin">Use a plugin<a class="headerlink" href="#use-a-plugin" title="Permanent link">&para;</a></h2>
<p>In this example we use a geoip database, that you need to find and download.
We expect that you did a <code>git clone git@github.com:zalando/skipper.git</code> and
entered the directory.</p>
<p>Build skipper:</p>
<div class="highlight"><pre><span></span><code>% make skipper
</code></pre></div>

<p>Install filter plugins:</p>
<div class="highlight"><pre><span></span><code>% mkdir plugins
% git clone git@github.com:skipper-plugins/filters.git plugins/filters
% ls plugins/filters
geoip/  glide.lock  glide.yaml  ldapauth/  Makefile  noop/  plugin_test.go
% cd plugins/filters/geoip
% GO111MODULE=on go build -buildmode=plugin -o geoip.so geoip.go
% cd -
~/go/src/github.com/zalando/skipper
</code></pre></div>

<p>Start a pseudo backend that shows all headers in plain:</p>
<div class="highlight"><pre><span></span><code>% nc -l 9000
</code></pre></div>

<p>Run the proxy with geoip database:</p>
<div class="highlight"><pre><span></span><code>% ./bin/skipper -filter-plugin geoip,db=$HOME/Downloads/GeoLite2-City_20181127/GeoLite2-City.mmdb -inline-routes &#39;* -&gt; geoip() -&gt; &quot;http://127.0.0.1:9000&quot;&#39;
[APP]INFO[0000] found plugin geoip at plugins/filters/geoip/geoip.so
[APP]INFO[0000] loaded plugin geoip (geoip) from plugins/filters/geoip/geoip.so
[APP]INFO[0000] attempting to load plugin from plugins/filters/geoip/geoip.so
[APP]INFO[0000] plugin geoip already loaded with InitFilter
[APP]INFO[0000] Expose metrics in codahale format
[APP]INFO[0000] support listener on :9911
[APP]INFO[0000] proxy listener on :9090
[APP]INFO[0000] route settings, reset, route: : * -&gt; geoip() -&gt; &quot;http://127.0.0.1:9000&quot;
[APP]INFO[0000] certPathTLS or keyPathTLS not found, defaulting to HTTP
[APP]INFO[0000] route settings received
[APP]INFO[0000] route settings applied
</code></pre></div>

<p>Or passing a yaml file via <code>config-file</code> flag:</p>
<div class="highlight"><pre><span></span><code><span class="nt">inline-routes</span><span class="p">:</span> <span class="s">&#39;*</span><span class="nv"> </span><span class="s">-&gt;</span><span class="nv"> </span><span class="s">geoip()</span><span class="nv"> </span><span class="s">-&gt;</span><span class="nv"> </span><span class="s">&quot;http://127.0.0.1:9000&quot;&#39;</span>
<span class="nt">filter-plugin</span><span class="p">:</span>
  <span class="nt">geoip</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">db=$HOME/Downloads/GeoLite2-City_20181127/GeoLite2-City.mmdb</span>
</code></pre></div>

<p>Use a client to lookup geoip:</p>
<div class="highlight"><pre><span></span><code>% curl -H&quot;X-Forwarded-For: 107.12.53.5&quot; localhost:9090/
^C
</code></pre></div>

<p>pseudo backend should show X-Geoip-Country header:</p>
<div class="highlight"><pre><span></span><code># nc -l 9000
GET / HTTP/1.1
Host: 127.0.0.1:9000
User-Agent: curl/7.49.0
Accept: */*
X-Forwarded-For: 107.12.53.5
X-Geoip-Country: US
Accept-Encoding: gzip
^C
</code></pre></div>

<p>skipper should show additional log lines, because of the CTRL-C:</p>
<div class="highlight"><pre><span></span><code>[APP]ERRO[0082] error while proxying, route  with backend http://127.0.0.1:9000, status code 500: dialing failed false: EOF
107.12.53.5 - - [28/Nov/2018:14:39:40 +0100] &quot;GET / HTTP/1.1&quot; 500 22 &quot;-&quot; &quot;curl/7.49.0&quot; 2753 localhost:9090 - -
</code></pre></div>

<h2 id="filter-plugins">Filter plugins<a class="headerlink" href="#filter-plugins" title="Permanent link">&para;</a></h2>
<p>All plugins must have a function named <code>InitFilter</code> with the following signature</p>
<div class="codehilite"><pre><span></span><code><span class="err">func([]string) (filters.Spec, error)</span>
</code></pre></div>


<p>The parameters passed are all arguments for the plugin, i.e. everything after the first
word from skipper&rsquo;s <code>-filter-plugin</code> parameter. E.g. when the <code>-filter-plugin</code>
parameter is</p>
<div class="codehilite"><pre><span></span><code><span class="err">myfilter,datafile=/path/to/file,foo=bar</span>
</code></pre></div>


<p>the <code>myfilter</code> plugin will receive</p>
<div class="codehilite"><pre><span></span><code><span class="err">[]string{&quot;datafile=/path/to/file&quot;, &quot;foo=bar&quot;}</span>
</code></pre></div>


<p>as arguments.</p>
<p>The filter plugin implementation is responsible to parse the received arguments.</p>
<p>Filter plugins can be found in the <a href="https://github.com/skipper-plugins/filters">filter repo</a></p>
<h3 id="example-filter-plugin">Example filter plugin<a class="headerlink" href="#example-filter-plugin" title="Permanent link">&para;</a></h3>
<p>An example <code>noop</code> plugin looks like</p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;github.com/zalando/skipper/filters&quot;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">noopSpec</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="nx">InitFilter</span><span class="p">(</span><span class="nx">opts</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">filters</span><span class="p">.</span><span class="nx">Spec</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">noopSpec</span><span class="p">{},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">noopSpec</span><span class="p">)</span> <span class="nx">Name</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&quot;noop&quot;</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">noopSpec</span><span class="p">)</span> <span class="nx">CreateFilter</span><span class="p">(</span><span class="nx">config</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">filters</span><span class="p">.</span><span class="nx">Filter</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">noopFilter</span><span class="p">{},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">noopFilter</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="nx">noopFilter</span><span class="p">)</span> <span class="nx">Request</span><span class="p">(</span><span class="nx">filters</span><span class="p">.</span><span class="nx">FilterContext</span><span class="p">)</span>  <span class="p">{}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="nx">noopFilter</span><span class="p">)</span> <span class="nx">Response</span><span class="p">(</span><span class="nx">filters</span><span class="p">.</span><span class="nx">FilterContext</span><span class="p">)</span> <span class="p">{}</span>
</code></pre></div>

<h2 id="predicate-plugins">Predicate plugins<a class="headerlink" href="#predicate-plugins" title="Permanent link">&para;</a></h2>
<p>All plugins must have a function named <code>InitPredicate</code> with the following signature</p>
<div class="codehilite"><pre><span></span><code><span class="err">func([]string) (routing.PredicateSpec, error)</span>
</code></pre></div>


<p>The parameters passed are all arguments for the plugin, i.e. everything after the first
word from skipper&rsquo;s <code>-predicate-plugin</code> parameter. E.g. when the <code>-predicate-plugin</code>
parameter is</p>
<div class="codehilite"><pre><span></span><code><span class="err">mypred,datafile=/path/to/file,foo=bar</span>
</code></pre></div>


<p>the <code>mypred</code> plugin will receive</p>
<div class="codehilite"><pre><span></span><code><span class="err">[]string{&quot;datafile=/path/to/file&quot;, &quot;foo=bar&quot;}</span>
</code></pre></div>


<p>as arguments.</p>
<p>The predicate plugin implementation is responsible to parse the received arguments.</p>
<p>Predicate plugins can be found in the <a href="https://github.com/skipper-plugins/predicates">predicate repo</a></p>
<h3 id="example-predicate-plugin">Example predicate plugin<a class="headerlink" href="#example-predicate-plugin" title="Permanent link">&para;</a></h3>
<p>An example <code>MatchAll</code> plugin looks like</p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;github.com/zalando/skipper/routing&quot;</span>
    <span class="s">&quot;net/http&quot;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">noopSpec</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="nx">InitPredicate</span><span class="p">(</span><span class="nx">opts</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">routing</span><span class="p">.</span><span class="nx">PredicateSpec</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">noopSpec</span><span class="p">{},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">noopSpec</span><span class="p">)</span> <span class="nx">Name</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&quot;MatchAll&quot;</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">noopSpec</span><span class="p">)</span> <span class="nx">Create</span><span class="p">(</span><span class="nx">config</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">routing</span><span class="p">.</span><span class="nx">Predicate</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">noopPredicate</span><span class="p">{},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">noopPredicate</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="nx">noopPredicate</span><span class="p">)</span> <span class="nx">Match</span><span class="p">(</span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="dataclient-plugins">DataClient plugins<a class="headerlink" href="#dataclient-plugins" title="Permanent link">&para;</a></h2>
<p>Similar to the above predicate and filter plugins. The command line option for data
client plugins is <code>-dataclient-plugin</code>. The module must have a <code>InitDataClient</code>
function with the signature</p>
<div class="codehilite"><pre><span></span><code><span class="err">func([]string) (routing.DataClient, error)</span>
</code></pre></div>


<p>A <code>noop</code> data client looks like</p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;github.com/zalando/skipper/eskip&quot;</span>
    <span class="s">&quot;github.com/zalando/skipper/routing&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">InitDataClient</span><span class="p">([]</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">routing</span><span class="p">.</span><span class="nx">DataClient</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">dc</span> <span class="nx">DataClient</span> <span class="p">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">return</span> <span class="nx">dc</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">DataClient</span> <span class="kt">string</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">dc</span> <span class="nx">DataClient</span><span class="p">)</span> <span class="nx">LoadAll</span><span class="p">()</span> <span class="p">([]</span><span class="o">*</span><span class="nx">eskip</span><span class="p">.</span><span class="nx">Route</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">eskip</span><span class="p">.</span><span class="nx">Parse</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">dc</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">dc</span> <span class="nx">DataClient</span><span class="p">)</span> <span class="nx">LoadUpdate</span><span class="p">()</span> <span class="p">([]</span><span class="o">*</span><span class="nx">eskip</span><span class="p">.</span><span class="nx">Route</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="multitype-plugins">MultiType plugins<a class="headerlink" href="#multitype-plugins" title="Permanent link">&para;</a></h2>
<p>Sometimes it is necessary to combine multiple plugin types into one module. This can
be done with this kind of plugin. Note that these modules are not auto loaded, these
need an explicit <code>-multi-plugin name,arg1,arg2</code> command line switch for skipper.</p>
<p>The module must have a <code>InitPlugin</code> function with the signature</p>
<div class="codehilite"><pre><span></span><code><span class="err">func([]string) ([]filters.Spec, []routing.PredicateSpec, []routing.DataClient, error)</span>
</code></pre></div>


<p>Any of the returned types may be nil, so you can have e.g. a combined filter / data client
plugin or share a filter and a predicate, e.g. like</p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;net&quot;</span>
    <span class="s">&quot;net/http&quot;</span>
    <span class="s">&quot;strconv&quot;</span>
    <span class="s">&quot;strings&quot;</span>

    <span class="nx">ot</span> <span class="s">&quot;github.com/opentracing/opentracing-go&quot;</span>
    <span class="nx">maxminddb</span> <span class="s">&quot;github.com/oschwald/maxminddb-golang&quot;</span>

    <span class="s">&quot;github.com/zalando/skipper/filters&quot;</span>
    <span class="nx">snet</span> <span class="s">&quot;github.com/zalando/skipper/net&quot;</span>
    <span class="s">&quot;github.com/zalando/skipper/predicates&quot;</span>
    <span class="s">&quot;github.com/zalando/skipper/routing&quot;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">geoipSpec</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">db</span>   <span class="o">*</span><span class="nx">maxminddb</span><span class="p">.</span><span class="nx">Reader</span>
    <span class="nx">name</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">InitPlugin</span><span class="p">(</span><span class="nx">opts</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="nx">filters</span><span class="p">.</span><span class="nx">Spec</span><span class="p">,</span> <span class="p">[]</span><span class="nx">routing</span><span class="p">.</span><span class="nx">PredicateSpec</span><span class="p">,</span> <span class="p">[]</span><span class="nx">routing</span><span class="p">.</span><span class="nx">DataClient</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">db</span> <span class="kt">string</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">o</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">HasPrefix</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="s">&quot;db=&quot;</span><span class="p">):</span>
            <span class="nx">db</span> <span class="p">=</span> <span class="nx">o</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">db</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;missing db= parameter for geoip plugin&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">reader</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">maxminddb</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;failed to open db %s: %s&quot;</span><span class="p">,</span> <span class="nx">db</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">[]</span><span class="nx">filters</span><span class="p">.</span><span class="nx">Spec</span><span class="p">{</span><span class="o">&amp;</span><span class="nx">geoipSpec</span><span class="p">{</span><span class="nx">db</span><span class="p">:</span> <span class="nx">reader</span><span class="p">,</span> <span class="nx">name</span><span class="p">:</span> <span class="s">&quot;geoip&quot;</span><span class="p">}},</span>
        <span class="p">[]</span><span class="nx">routing</span><span class="p">.</span><span class="nx">PredicateSpec</span><span class="p">{</span><span class="o">&amp;</span><span class="nx">geoipSpec</span><span class="p">{</span><span class="nx">db</span><span class="p">:</span> <span class="nx">reader</span><span class="p">,</span> <span class="nx">name</span><span class="p">:</span> <span class="s">&quot;GeoIP&quot;</span><span class="p">}},</span>
        <span class="kc">nil</span><span class="p">,</span>
        <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">geoipSpec</span><span class="p">)</span> <span class="nx">Name</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">name</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">geoipSpec</span><span class="p">)</span> <span class="nx">CreateFilter</span><span class="p">(</span><span class="nx">config</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">filters</span><span class="p">.</span><span class="nx">Filter</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fromLast</span> <span class="kt">bool</span>
    <span class="nx">header</span> <span class="o">:=</span> <span class="s">&quot;X-GeoIP-Country&quot;</span>
    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">config</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.(</span><span class="kt">string</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">HasPrefix</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="s">&quot;from_last=&quot;</span><span class="p">):</span>
                <span class="nx">fromLast</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">ParseBool</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">10</span><span class="p">:])</span>
                <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">filters</span><span class="p">.</span><span class="nx">ErrInvalidFilterParameters</span>
                <span class="p">}</span>
            <span class="k">case</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">HasPrefix</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="s">&quot;header=&quot;</span><span class="p">):</span>
                <span class="nx">header</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">geoip</span><span class="p">{</span><span class="nx">db</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">db</span><span class="p">,</span> <span class="nx">fromLast</span><span class="p">:</span> <span class="nx">fromLast</span><span class="p">,</span> <span class="nx">header</span><span class="p">:</span> <span class="nx">header</span><span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">geoipSpec</span><span class="p">)</span> <span class="nx">Create</span><span class="p">(</span><span class="nx">config</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">routing</span><span class="p">.</span><span class="nx">Predicate</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fromLast</span> <span class="kt">bool</span>
    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
    <span class="nx">countries</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">struct</span><span class="p">{})</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">config</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.(</span><span class="kt">string</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">HasPrefix</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="s">&quot;from_last=&quot;</span><span class="p">):</span>
                <span class="nx">fromLast</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">ParseBool</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">10</span><span class="p">:])</span>
                <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">predicates</span><span class="p">.</span><span class="nx">ErrInvalidPredicateParameters</span>
                <span class="p">}</span>
            <span class="k">default</span><span class="p">:</span>
                <span class="nx">countries</span><span class="p">[</span><span class="nx">strings</span><span class="p">.</span><span class="nx">ToUpper</span><span class="p">(</span><span class="nx">s</span><span class="p">)]</span> <span class="p">=</span> <span class="kd">struct</span><span class="p">{}{}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">geoip</span><span class="p">{</span><span class="nx">db</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">db</span><span class="p">,</span> <span class="nx">fromLast</span><span class="p">:</span> <span class="nx">fromLast</span><span class="p">,</span> <span class="nx">countries</span><span class="p">:</span> <span class="nx">countries</span><span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">geoip</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">db</span>        <span class="o">*</span><span class="nx">maxminddb</span><span class="p">.</span><span class="nx">Reader</span>
    <span class="nx">fromLast</span>  <span class="kt">bool</span>
    <span class="nx">header</span>    <span class="kt">string</span>
    <span class="nx">countries</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">countryRecord</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Country</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">ISOCode</span> <span class="kt">string</span> <span class="s">`maxminddb:&quot;iso_code&quot;`</span>
    <span class="p">}</span> <span class="s">`maxminddb:&quot;country&quot;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">geoip</span><span class="p">)</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">src</span> <span class="nx">net</span><span class="p">.</span><span class="nx">IP</span>
    <span class="k">if</span> <span class="nx">g</span><span class="p">.</span><span class="nx">fromLast</span> <span class="p">{</span>
        <span class="nx">src</span> <span class="p">=</span> <span class="nx">snet</span><span class="p">.</span><span class="nx">RemoteHostFromLast</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">src</span> <span class="p">=</span> <span class="nx">snet</span><span class="p">.</span><span class="nx">RemoteHost</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">record</span> <span class="o">:=</span> <span class="nx">countryRecord</span><span class="p">{}</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">Lookup</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">record</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;geoip(): failed to lookup %s: %s&quot;</span><span class="p">,</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">record</span><span class="p">.</span><span class="nx">Country</span><span class="p">.</span><span class="nx">ISOCode</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;UNKNOWN&quot;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">record</span><span class="p">.</span><span class="nx">Country</span><span class="p">.</span><span class="nx">ISOCode</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">geoip</span><span class="p">)</span> <span class="nx">Request</span><span class="p">(</span><span class="nx">c</span> <span class="nx">filters</span><span class="p">.</span><span class="nx">FilterContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">().</span><span class="nx">Header</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">header</span><span class="p">,</span> <span class="nx">g</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">()))</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">geoip</span><span class="p">)</span> <span class="nx">Response</span><span class="p">(</span><span class="nx">c</span> <span class="nx">filters</span><span class="p">.</span><span class="nx">FilterContext</span><span class="p">)</span> <span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">geoip</span><span class="p">)</span> <span class="nx">Match</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="nx">span</span> <span class="o">:=</span> <span class="nx">ot</span><span class="p">.</span><span class="nx">SpanFromContext</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Context</span><span class="p">())</span>
    <span class="k">if</span> <span class="nx">span</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">span</span><span class="p">.</span><span class="nx">LogKV</span><span class="p">(</span><span class="s">&quot;GeoIP&quot;</span><span class="p">,</span> <span class="s">&quot;start&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">code</span> <span class="o">:=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">countries</span><span class="p">[</span><span class="nx">code</span><span class="p">]</span>

    <span class="k">if</span> <span class="nx">span</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">span</span><span class="p">.</span><span class="nx">LogKV</span><span class="p">(</span><span class="s">&quot;GeoIP&quot;</span><span class="p">,</span> <span class="nx">code</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">ok</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="opentracing-plugins">OpenTracing plugins<a class="headerlink" href="#opentracing-plugins" title="Permanent link">&para;</a></h2>
<p>The tracers, except for <code>noop</code>, are built as Go Plugins. A tracing plugin can
be loaded with <code>-opentracing NAME</code> as parameter to skipper.</p>
<p>Implementations of OpenTracing API can be found in the
<a href="https://github.com/skipper-plugins/opentracing">https://github.com/skipper-plugins/opentracing</a> repository.</p>
<p>All plugins must have a function named <code>InitTracer</code> with the following signature</p>
<div class="codehilite"><pre><span></span><code><span class="err">func([]string) (opentracing.Tracer, error)</span>
</code></pre></div>


<p>The parameters passed are all arguments for the plugin, i.e. everything after the first
word from skipper&rsquo;s -opentracing parameter. E.g. when the -opentracing parameter is
<code>mytracer foo=bar token=xxx somename=bla:3</code> the &ldquo;mytracer&rdquo; plugin will receive</p>
<div class="codehilite"><pre><span></span><code><span class="err">[]string{&quot;foo=bar&quot;, &quot;token=xxx&quot;, &quot;somename=bla:3&quot;}</span>
</code></pre></div>


<p>as arguments.</p>
<p>The tracer plugin implementation is responsible to parse the received arguments.</p>
<p>An example plugin looks like
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
     <span class="nx">basic</span> <span class="s">&quot;github.com/opentracing/basictracer-go&quot;</span>
     <span class="nx">opentracing</span> <span class="s">&quot;github.com/opentracing/opentracing-go&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">InitTracer</span><span class="p">(</span><span class="nx">opts</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">opentracing</span><span class="p">.</span><span class="nx">Tracer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">return</span> <span class="nx">basic</span><span class="p">.</span><span class="nx">NewTracerWithOptions</span><span class="p">(</span><span class="nx">basic</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
         <span class="nx">Recorder</span><span class="p">:</span>       <span class="nx">basic</span><span class="p">.</span><span class="nx">NewInMemoryRecorder</span><span class="p">(),</span>
         <span class="nx">ShouldSample</span><span class="p">:</span>   <span class="kd">func</span><span class="p">(</span><span class="nx">traceID</span> <span class="kt">uint64</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">traceID</span><span class="o">%</span><span class="mi">64</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">},</span>
         <span class="nx">MaxLogsPerSpan</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
     <span class="p">}),</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div></p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../scripts/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Scripts" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Scripts
            </div>
          </div>
        </a>
      
      
        
        <a href="../architecture/" class="md-footer__link md-footer__link--next" aria-label="Next: Architecture" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Architecture
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.ddd52ceb.min.js"></script>
      
    
  </body>
</html>